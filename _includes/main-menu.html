<div id="main-menu" class="main-menu">
  {% assign mainmenu = site.data.menus.main | sort: 'weight' %}
  <ul>
    {% for item in mainmenu %}
      {% assign label = item.name | default: item.key %}
      {% if site.data.i18n and site.active_lang and item.key and site.data.i18n[site.active_lang] and site.data.i18n[site.active_lang].menu and site.data.i18n[site.active_lang].menu[item.key] %}
        {% assign label = site.data.i18n[site.active_lang].menu[item.key] %}
      {% endif %}

      {%- comment -%}
      Let Polyglot generate the correct language-aware URL for the menu item.
      Avoid manual "/de/" prefixing, because it can break pairing and URL normalization.
      {%- endcomment -%}
      {% assign href = item.url | localized_url | relative_url %}

      {%- comment -%}
      Active state: depending on your setup, `page.url` may be language-prefixed
      while `item.url` is not. Comparing against the localized item URL is safer.
      {%- endcomment -%}
      {% assign item_local = item.url | localized_url %}
      <li class="{% if page.url == item.url or page.url == item_local %}active{% endif %}">
        <a href="{{ href }}">{{ label }}</a>
      </li>
    {% endfor %}

    {%- comment -%}
    Language switch:
    Normalize `page.url` into a language-neutral path BEFORE passing to `localized_url`.
    This handles "/de", "/de/", and deeper paths like "/de/services/".
    Also keep valid HTML: <ul> should contain <li>, not a raw <div>.
    {%- endcomment -%}

    {% assign path = page.url %}

    {% assign lang_prefix1 = '/' | append: site.active_lang %}
    {% assign lang_prefix2 = lang_prefix1 | append: '/' %}

    {% if path == lang_prefix1 %}
      {% assign path = '/' %}
    {% elsif path contains lang_prefix2 %}
      {% assign path = path | remove_first: lang_prefix2 %}
      {% assign path = '/' | append: path %}
    {% endif %}

    <li class="lang-switch">
      {% for lang in site.languages %}
        {% if lang == site.active_lang %}
          <span class="active-lang">{{ lang | upcase }}</span>
        {% else %}
          <a class="lang-link" href="{{ path | localized_url: lang | relative_url }}">
            {{ lang | upcase }}
          </a>
        {% endif %}
      {% endfor %}
    </li>
  </ul>
</div>
