<div id="main-menu" class="main-menu">
  {% assign mainmenu = site.data.menus.main | sort: 'weight' %}
  <ul>
    {% for item in mainmenu %}
      {% assign label = item.name | default: item.key %}
      {% if site.data.i18n and site.active_lang and item.key and site.data.i18n[site.active_lang] and site.data.i18n[site.active_lang].menu and site.data.i18n[site.active_lang].menu[item.key] %}
        {% assign label = site.data.i18n[site.active_lang].menu[item.key] %}
      {% endif %}

      {% assign href = item.url | relative_url %}
      
      {% comment %} If we are in German (or any non-default lang), force the prefix {% endcomment %}
      {% if site.active_lang != site.default_lang %}
        {% assign href = item.url | prepend: '/' | prepend: site.active_lang | replace: '//', '/' | relative_url %}
      {% endif %}

      <li class="{% if item.url == page.url %}active{% endif %}">
        <a href="{{ href }}">{{ label }}</a>
      </li>
    {% endfor %}
    
    {%- comment -%}
    Build a language-agnostic path (remove any leading /de or /en),
    then construct the target URL for each language from that.
    {%- endcomment -%}

    {%- assign canonical_path = page.url -%}

    {%- comment -%} strip language prefix variants {%- endcomment -%}
    {%- assign canonical_path = canonical_path | replace_first: '/de/', '/' -%}
    {%- assign canonical_path = canonical_path | replace_first: '/de', '' -%}
    {%- assign canonical_path = canonical_path | replace_first: '/en/', '/' -%}
    {%- assign canonical_path = canonical_path | replace_first: '/en', '' -%}

    {%- comment -%} normalize double slashes {%- endcomment -%}
    {%- assign canonical_path = canonical_path | replace: '//', '/' -%}

    <div class="lang-switch">
      {% for language in site.languages %}
        {% if language == site.active_lang %}
          <span class="active-lang">{{ language | upcase }}</span>
        {% else %}
          {% if language == site.default_lang %}
            <a class="lang-link" href="{{ canonical_path | relative_url }}">
              {{ language | upcase }}
            </a>
          {% else %}
            <a class="lang-link" href="{{ '/' | append: language | append: canonical_path | replace: '//', '/' | relative_url }}">
              {{ language | upcase }}
            </a>
          {% endif %}
        {% endif %}
      {% endfor %}
    </div>


  </ul>
</div>
